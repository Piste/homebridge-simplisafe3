<div class="card">
  <div class="card-body text-center">
    <div id="authExists">
      <p class="mb-0">
        <strong>Authentication has been setup already.</strong> <a id="showAuth" href="#auth">Show Authentication Instructions.</a>
      </p>
    </div>
    <div id="auth" class="pt-2">
      <p class="form-text small">
        Click the button below to launch the SimpliSafe login page. Once you verify via email the process will automatically complete.
        Your login username and password are not saved.
      </p>
      <p class="form-text small">
        See <a target='_blank' href='https://github.com/homebridge-simplisafe3/homebridge-simplisafe3/blob/master/README.md#simplisafe-authentication'>README</a> for more information.
      </p>
      <form id="loginForm" class="text-left">
        <label for="username">SimpliSafe Username</label>
        <input type="text" class="form-control" id="username" aria-describedby="username">
        <small id="username" class="form-text text-muted">Enter username</small>
        <label for="password">SimpliSafe Password</label>
        <input type="password" class="form-control" id="password" aria-describedby="password">
        <small id="password" class="form-text text-muted">Enter password</small>
      </form>
      <button target="_blank" id="ssLoginButton" class="btn btn-primary btn-lg">Launch SimpliSafe Login</button>
    </div>
  </div>
</div>

<!-- Modules -->
<script type="text/javascript" src="js/modules/jquery.min.js"></script>

<script>
(async () => {
  let mfaCheckIntervalID;
  $('#authExists').slideUp(0);

  // get the current homebridge config
  const pluginConfig = await homebridge.getPluginConfig();
  if (!pluginConfig.length) {
      pluginConfig.push({ name: 'Home Alarm' })
      await homebridge.updatePluginConfig(pluginConfig)
  }

  homebridge.showSchemaForm();

  const credentialsExistResponse = await homebridge.request('/credentialsExist');
  if (credentialsExistResponse.success && credentialsExistResponse.credentialsExist) {
      $('#authExists').slideDown(0);
      $('#auth').slideUp(0);
  }

  $('#ssLoginButton').click(async function() {
    const initiateLogin = await homebridge.request('/initiateLogin', {
      username: $('#username').val(),
      password: $('#password').val(),
    });

    if (initiateLogin.success) {
      $('#loginForm').slideUp();
      homebridge.showSpinner();
      mfaCheckIntervalID = setInterval(async () => {
        const authCheck = await homebridge.request('/checkForAuth');
        if (authCheck.success) {
          clearInterval(mfaCheckIntervalID);
          homebridge.hideSpinner();
          $('#auth').slideUp(0);
          $('#authExists').slideDown();
          homebridge.toast.success('Restart to apply the changes.', 'Authorization Successful');
        } else if (authCheck.error) {
          homebridge.toast.error('Please try again.', 'Authentication Failure');
        }
      }, 3300);
    } else {
      homebridge.toast.error('Please try again.', 'Error initiating login');
    }
  });

  $('#showAuth').click(function() {
      $('#auth').slideDown();
  });

})();
</script>
