<div class="card">
  <div class="card-body text-center">
    <h4 class="card-title">SimpliSafe Authentication</h4>
    <div id="auth-exists">
      <p class="mb-0">
        <strong>Authentication has been setup.</strong> <a id="show-auth" href="#auth">Show Authentication Form.</a>
      </p>
    </div>
    <div id="auth-loading" class="mx-md-5 my-2">
      <div class="progress" style="height: 1px;">
        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <p id="message" class="pt-1"></p>
    </div>
    <div id="auth">
      <form id="ss-login-form" class="pt-2">
        <p class="form-text small px-md-5 mx-md-5">
          Click the button below to start the SimpliSafe authentication process.
          Once you verify the login via email this will automatically complete.
          See <a target='_blank' href='https://github.com/homebridge-simplisafe3/homebridge-simplisafe3/blob/master/README.md#simplisafe-authentication'>README</a> for more information.
        </p>
        <div class="text-left mx-md-8 px-md-5">
          <div class="form-group">
            <label for="username">SimpliSafe Email</label>
            <input type="email" required placeholder="name@example.com" class="form-control" id="username">
          </div>
          <div class="form-group">
            <label for="password">SimpliSafe Password</label>
            <input type="password" required class="form-control" id="password" aria-describedby="password">
            <small id="password" class="form-text text-muted">Password is not stored.</small>
          </div>
        </div>
        <button type="submit" id="ss-login-button" class="btn btn-primary">Start Authentication</button>
      </form>
    </div>
  </div>
</div>

<style type="text/css">
  @media (min-width: 768px) {
    .mx-md-8 {
      margin-left: 8rem !important;
      margin-right: 8rem !important;
    }
  }
</style>

<!-- Modules -->
<script type="text/javascript" src="js/modules/jquery.min.js"></script>

<script>
(async () => {
  $('#auth-exists').slideUp(0);
  $('#auth-loading').slideUp(0);
  let currentStep;
  let totalSteps;
  let lastStepMessage;

  // get the current homebridge config
  const pluginConfig = await homebridge.getPluginConfig();
  if (!pluginConfig.length) {
      pluginConfig.push({ name: 'Home Alarm' })
      await homebridge.updatePluginConfig(pluginConfig)
  }

  homebridge.showSchemaForm();

  const credentialsExistResponse = await homebridge.request('/credentialsExist');
  if (credentialsExistResponse.success && credentialsExistResponse.credentialsExist) {
    $('#auth-exists').slideDown(0);
    $('#auth').slideUp(0);
  }

  const nLoginSteps = await homebridge.request('/nLoginSteps');
  if (nLoginSteps.steps) {
    $('#auth-loading .progress-bar').attr('aria-valuemax', nLoginSteps.steps);
    totalSteps = nLoginSteps.steps;
  }

  homebridge.addEventListener('login-step', (event) => {
      if (event.data.isError) {
          $('#auth-loading #message').text();
          $('#auth-loading').slideUp(0);
          $('#show-auth').click();
          homebridge.toast.error(event.data.message);
          console.log(`Error: ${event.data.message}`);
      } else {
        console.log(event.data.message);
        if (lastStepMessage !== event.data.message) currentStep++; // for repeating steps
        console.log(currentStep, $('#auth-loading .progress-bar').attr('aria-valuenow'), lastStepMessage, lastStepMessage == event.data.message);
        $('#auth-loading .progress-bar').attr('aria-valuenow', currentStep);
        $('#auth-loading .progress-bar').css('width', `${100 * currentStep / totalSteps}%`);
        $('#auth-loading #message').text(event.data.message);
        lastStepMessage = event.data.message;
      }
  });

  homebridge.addEventListener('login-complete', (event) => {
      $('#auth').slideUp(0);
      $('#auth-loading').slideUp(0);
      $('#auth-exists').slideDown();
      homebridge.toast.success('Restart to apply the changes.', 'Authorization Successful');
  });

  $('#show-auth').click(function() {
      $('#ss-login-form').slideDown(0);
      $('#auth').slideDown();
      $('#auth-exists').slideUp();
  });

  $('#ss-login-form').submit(doLogin);
  
  async function doLogin(event) {
    if (event) event.preventDefault();
    
    // reset
    currentStep = 1;
    $('#auth-loading #message').text();

    const initiateLogin = await homebridge.request('/initiateLogin', {
      username: $('#username').val(),
      password: $('#password').val(),
    });

    if (initiateLogin.success) {
      $('#ss-login-form').slideUp();
      $('#auth-loading').slideDown();
      $('#auth-exists').slideUp();

      homebridge.toast.info('Please wait...', 'Initiating Login'); // then we wait for push event 'login-complete'
    } else {
      homebridge.toast.error('Please try again.', 'Error initiating login');
    }
  }

})();
</script>
